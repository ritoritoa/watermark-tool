<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="画像に透かしウォーターマークを追加するシンプルなWebツール">
    <title>ウォーターマーク追加ツール</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Noto+Sans+JP:wght@400;500;700&family=Parisienne&family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#0f0f1a">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((err) => console.log('Service Worker Failed', err));
        }
    </script>
</head>

<body>
    <div class="app-container">
        <header class="header">
            <h1>🎨 ウォーターマーク追加ツール</h1>
            <p class="subtitle">画像に著作権表示を簡単追加</p>
        </header>

        <main class="main-content">
            <!-- タブナビゲーション -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="main">🎨 メイン</button>
                <button class="tab-btn" data-tab="diff">🔍 Diff比較</button>
            </div>

            <!-- メインセクション -->
            <div id="mainSection" class="tab-section">
                <!-- ドロップエリア -->
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <div class="drop-icon">📁</div>
                        <p class="drop-text">画像をドラッグ＆ドロップ</p>
                        <p class="drop-subtext">または</p>
                        <label class="file-select-btn">
                            ファイルを選択
                            <input type="file" id="fileInput" accept="image/*" hidden>
                        </label>
                    </div>
                </div>

                <!-- プレビューエリア -->
                <div class="preview-area" id="previewArea" style="display: none;">
                    <div class="preview-header">
                        <h2>プレビュー</h2>
                        <button class="reset-btn" id="resetBtn">🔄 別の画像を選択</button>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>

                <!-- コントロールパネル -->
                <div class="control-panel" id="controlPanel" style="display: none;">
                    <h2>⚙️ 設定</h2>

                    <div class="control-group">
                        <label>ウォーターマーク種類</label>
                        <div class="mode-options">
                            <button class="mode-btn active" data-mode="text">✏️ テキスト</button>
                            <button class="mode-btn" data-mode="image">🖼️ 画像</button>
                            <button class="mode-btn" data-mode="composite">✨ テキスト+画像</button>
                        </div>
                    </div>

                    <!-- 画像ウォーターマーク設定 -->
                    <div class="control-group image-watermark-section" id="imageWatermarkSection"
                        style="display: none;">
                        <label>透過画像をアップロード</label>
                        <label class="watermark-upload-btn">
                            📁 画像を選択
                            <input type="file" id="watermarkImageInput" accept="image/png" hidden>
                        </label>
                        <div id="watermarkImagePreview" class="watermark-image-preview"></div>

                        <!-- 画像専用スライダー -->
                        <div class="image-specific-controls">
                            <div class="control-group">
                                <label for="imgOpacity">透明度: <span id="imgOpacityValue">70</span>%</label>
                                <input type="range" id="imgOpacity" min="10" max="100" value="70">
                            </div>
                            <div class="control-group">
                                <label for="imgAngle">角度: <span id="imgAngleValue">-30</span>°</label>
                                <input type="range" id="imgAngle" min="-90" max="90" value="-30">
                            </div>
                            <div class="control-group">
                                <label for="imgSpacing">間隔: <span id="imgSpacingValue">150</span>px</label>
                                <input type="range" id="imgSpacing" min="50" max="300" value="150">
                            </div>
                            <div class="control-group">
                                <label for="imgJitter">ゆらぎ: <span id="imgJitterValue">0</span></label>
                                <input type="range" id="imgJitter" min="0" max="100" value="0">
                            </div>
                            <div class="control-group">
                                <label for="imgScale">サイズ: <span id="imgScaleValue">100</span>%</label>
                                <input type="range" id="imgScale" min="10" max="200" value="100">
                            </div>
                            <div class="control-group">
                                <label>合成モード（画像用）</label>
                                <div class="blend-options">
                                    <button class="img-blend-btn active" data-img-blend="source-over">通常</button>
                                    <button class="img-blend-btn" data-img-blend="overlay">馴染ませる</button>
                                    <button class="img-blend-btn" data-img-blend="multiply">暗くする</button>
                                    <button class="img-blend-btn" data-img-blend="screen">明るくする</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- テキストウォーターマーク設定 -->
                    <div class="text-watermark-section" id="textWatermarkSection">
                        <div class="control-group">
                            <label for="watermarkText">ウォーターマークテキスト</label>
                            <input type="text" id="watermarkText" placeholder="例: © 2026 Your Name" value="© Sample">
                        </div>

                        <div class="control-group">
                            <label>フォント</label>
                            <div class="font-options">
                                <button class="font-btn active" data-font="normal">📝 標準</button>
                                <button class="font-btn" data-font="italic">✨ イタリック</button>
                                <button class="font-btn" data-font="cute">🎀 まる</button>
                            </div>
                            <div class="font-options" style="margin-top: 0.5rem;">
                                <button class="font-btn" data-font="great-vibes">✍️ 筆記体</button>
                                <button class="font-btn" data-font="dancing">💃 ダンス</button>
                                <button class="font-btn" data-font="parisienne">🇫🇷 パリジェンヌ</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <label for="fontSize">フォントサイズ: <span id="fontSizeValue">24</span>px</label>
                            <input type="range" id="fontSize" min="12" max="72" value="24">
                        </div>

                        <div class="control-group">
                            <label>色</label>
                            <div class="color-options">
                                <button class="color-btn active" data-color="white">白</button>
                                <button class="color-btn" data-color="black">黒</button>
                                <button class="color-btn" data-color="auto">自動</button>
                                <button class="color-btn" data-color="gradient">🌈 虹色</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <label>スタイル</label>
                            <div class="style-options">
                                <button class="style-btn active" data-style="normal">通常</button>
                                <button class="style-btn" data-style="outline">🔲 中抜き</button>
                                <button class="style-btn" data-style="halftone">ドット</button>
                                <button class="style-btn" data-style="analog">✏️ アナログ</button>
                            </div>
                            <div id="halftoneOptions" class="halftone-options" style="display: none;">
                                <label for="dotSize">ドットサイズ: <span id="dotSizeValue">3</span>px</label>
                                <input type="range" id="dotSize" min="1" max="8" value="3">
                            </div>
                        </div>
                    </div>

                    <!-- 共通設定 (どのモードでも表示) -->
                    <div id="commonControls">
                        <div class="control-group">
                            <label>合成モード（ブレンド）</label>
                            <div class="blend-options">
                                <button class="blend-btn active" data-blend="source-over">通常</button>
                                <button class="blend-btn" data-blend="overlay">馴染ませる</button>
                                <button class="blend-btn" data-blend="multiply">暗くする</button>
                                <button class="blend-btn" data-blend="screen">明るくする</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <label for="opacity">透明度: <span id="opacityValue">30</span>%</label>
                            <input type="range" id="opacity" min="5" max="200" value="30">
                            <p class="slider-hint">100%超で重ね描き（より濃く）</p>
                        </div>

                        <div class="control-group">
                            <label for="angle">角度: <span id="angleValue">-30</span>°</label>
                            <input type="range" id="angle" min="-90" max="90" value="-30">
                        </div>

                        <div class="control-group">
                            <label>仕上げエフェクト</label>
                            <div class="effect-controls">
                                <div class="sub-control">
                                    <label>🔲 ビネット (四隅効果)</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <button class="color-btn active" data-vignette-color="black"
                                            style="flex: 1; padding: 4px; font-size: 0.8rem;">⚫ 黒 (通常)</button>
                                        <button class="color-btn" data-vignette-color="white"
                                            style="flex: 1; padding: 4px; font-size: 0.8rem;">⚪ 白 (暗い画像用)</button>
                                    </div>
                                    <label for="vignette">濃さ: <span id="vignetteValue">0</span>%</label>
                                    <input type="range" id="vignette" min="0" max="150" value="0">

                                    <label for="vignetteSize" style="margin-top: 0.5rem;">広がり (エリア): <span
                                            id="vignetteSizeValue">50</span>%</label>
                                    <input type="range" id="vignetteSize" min="10" max="100" value="50">
                                </div>
                                <div class="sub-control">
                                    <label for="texture">📜 質感ノイズ: <span id="textureValue">0</span>%</label>
                                    <input type="range" id="texture" min="0" max="80" value="0">
                                </div>
                                <div class="sub-control">
                                    <label for="integration">🌫️ 文字のなじみ度: <span id="integrationValue">0</span>%</label>
                                    <input type="range" id="integration" min="0" max="100" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label for="jitter">🔀 ゆらぎ (Jitter): <span id="jitterValue">0</span>%</label>
                            <input type="range" id="jitter" min="0" max="100" value="0">
                        </div>

                        <div class="control-group">
                            <label for="spacing">間隔: <span id="spacingValue">150</span>px</label>
                            <input type="range" id="spacing" min="50" max="300" value="150">
                        </div>

                        <div class="control-group">
                            <label for="wmScale">ウォーターマークサイズ: <span id="wmScaleValue">100</span>%</label>
                            <input type="range" id="wmScale" min="10" max="200" value="100">
                        </div>

                        <div class="control-group protection-section">
                            <div class="protection-header">
                                <label class="protection-label">
                                    <input type="checkbox" id="noiseProtection">
                                    <span>🛡️ AIジャマー (除去を妨害)</span>
                                </label>
                                <div class="jammer-strength-control" id="jammerStrengthControl" style="display: none;">
                                    <label for="jammerStrength" style="font-size: 0.8rem;">強度: <span
                                            id="jammerStrengthValue">30</span></label>
                                    <input type="range" id="jammerStrength" min="10" max="100" value="30">
                                </div>
                            </div>
                            <p class="protection-desc">不規則な色ズレ（カオス攻撃）を埋め込みます。AIの予測を混乱させ、除去跡を汚くします。</p>
                        </div>

                        <!-- 三層ノイズ保護システム -->
                        <div class="control-group protection-section" id="threeLayerNoiseSection">
                            <div class="protection-header">
                                <label class="protection-label">
                                    <input type="checkbox" id="threeLayerNoise">
                                    <span>🛡️ 三層ノイズ保護 (AI除去耐性)</span>
                                </label>
                            </div>
                            <p class="protection-desc">低周波・中域・高周波の相関ノイズを埋め込み、除去しようとすると画像が破壊される構造を作ります。</p>

                            <div class="noise-controls" id="noiseControls" style="display: none;">
                                <div class="noise-slider-group">
                                    <label for="lowFreqNoise">🌊 低周波 (明暗うねり): <span
                                            id="lowFreqNoiseValue">30</span>%</label>
                                    <input type="range" id="lowFreqNoise" min="0" max="100" value="30">
                                    <p class="slider-hint">0=なし → 100=うねり強い</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="midFreqAngle">〰️ 中域 角度: <span id="midFreqAngleValue">45</span>°</label>
                                    <input type="range" id="midFreqAngle" min="-90" max="90" value="45">
                                    <p class="slider-hint">テクスチャの傾き方向</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="midFreqStrength">〰️ 中域 強度: <span
                                            id="midFreqStrengthValue">40</span>%</label>
                                    <input type="range" id="midFreqStrength" min="0" max="100" value="40">
                                    <p class="slider-hint">0=なし → 100=テクスチャ濃い</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="highFreqNoise">✨ 高周波 (細かい粒子): <span
                                            id="highFreqNoiseValue">50</span>%</label>
                                    <input type="range" id="highFreqNoise" min="0" max="100" value="50">
                                    <p class="slider-hint">0=なし → 100=粒子たくさん</p>
                                </div>
                                <div class="noise-slider-group correlation-slider">
                                    <label for="noiseCorrelation">🔗 層間相関度: <span
                                            id="noiseCorrelationValue">70</span>%</label>
                                    <input type="range" id="noiseCorrelation" min="0" max="100" value="70">
                                    <p class="slider-hint">0=各層バラバラ → 100=強く連動（AI除去に強い）</p>
                                </div>
                            </div>
                        </div>

                        <div class="control-group protection-section">
                            <label class="protection-label">
                                <input type="checkbox" id="tamperDetection">
                                <span>🔍 改ざん検出モード</span>
                            </label>
                            <p class="protection-desc">出力画像に「検出用レイヤーを含む」表示を追加し、ファイル名に _detect を付与します。</p>
                        </div>

                        <!-- AI復元困難化フィルタ -->
                        <div class="control-group protection-section" id="irrecoverableFilterSection">
                            <div class="protection-header">
                                <label class="protection-label">
                                    <input type="checkbox" id="irrecoverableFilter">
                                    <span>🔮 AI復元困難化フィルタ (上級)</span>
                                </label>
                            </div>
                            <p class="protection-desc">4層構造の高度なノイズでAIによる復元を困難にします。消した部分を自然に埋め合わせできなくなります。</p>

                            <div class="noise-controls" id="irrecoverableControls" style="display: none;">
                                <div class="noise-slider-group">
                                    <label for="perlinNoise">🌊 低周波ゆらぎ (Perlin): <span
                                            id="perlinNoiseValue">20</span>%</label>
                                    <input type="range" id="perlinNoise" min="0" max="100" value="20">
                                    <p class="slider-hint">背景の微細な明暗うねり。AIの塗りつぶしを不自然にする</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="blueNoise">✨ Blue Noise (高周波): <span
                                            id="blueNoiseValue">60</span>%</label>
                                    <input type="range" id="blueNoise" min="0" max="100" value="60">
                                    <p class="slider-hint">均一に見えて不規則な微粒子。質感の復元を阻害</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="directionalNoise">〰️ 方向性ノイズ: <span
                                            id="directionalNoiseValue">40</span>%</label>
                                    <input type="range" id="directionalNoise" min="0" max="100" value="40">
                                    <p class="slider-hint">微細な筆跡・線。AIの方向認識を混乱させる</p>
                                </div>
                                <div class="noise-slider-group correlation-slider">
                                    <label for="correlationField">🔗 相関フィールド: <span
                                            id="correlationFieldValue">65</span>%</label>
                                    <input type="range" id="correlationField" min="0" max="100" value="65">
                                    <p class="slider-hint">ブロック間の統計的依存。一部消すと全体が歪む</p>
                                </div>
                            </div>
                        </div>

                        <!-- Bタイプ不可視フィルタ（スクショ専用） -->
                        <div class="control-group protection-section" id="btypeFilterSection">
                            <div class="protection-header">
                                <label class="protection-label">
                                    <input type="checkbox" id="btypeFilter">
                                    <span>🔤 Bタイプ（黒背景×白文字専用）</span>
                                </label>
                            </div>
                            <p class="protection-desc">完全不可視。見た目は100%そのままで、OCR・復元AIだけが読めなくなります。</p>

                            <div class="noise-controls" id="btypeControls" style="display: none;">
                                <div class="noise-slider-group">
                                    <label for="phaseShift">📐 輪郭位相ずらし: <span id="phaseShiftValue">50</span>%</label>
                                    <input type="range" id="phaseShift" min="0" max="100" value="50">
                                    <p class="slider-hint">文字エッジをサブピクセル単位でズラす。OCRが字形を誤認</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="lumaMod">💡 白文字ゆらぎ: <span id="lumaModValue">50</span>%</label>
                                    <input type="range" id="lumaMod" min="0" max="100" value="50">
                                    <p class="slider-hint">白の中を微弱に揺らす。「均一な白」前提を崩す</p>
                                </div>
                                <div class="noise-slider-group">
                                    <label for="bgNoise">🌑 黒背景ノイズ: <span id="bgNoiseValue">50</span>%</label>
                                    <input type="range" id="bgNoise" min="0" max="100" value="50">
                                    <p class="slider-hint">黒の中に極微のノイズ。背景除去AIを混乱させる</p>
                                </div>
                                <div class="noise-slider-group correlation-slider">
                                    <label for="btypeCorrelation">🔗 タイル相関: <span
                                            id="btypeCorrelationValue">58</span>%</label>
                                    <input type="range" id="btypeCorrelation" min="0" max="100" value="58">
                                    <p class="slider-hint">8×8タイルで全層を連動。部分消去で全体破綻</p>
                                </div>
                            </div>
                        </div>

                        <button class="download-btn" id="downloadBtn">
                            💾 ダウンロード (PNG)
                        </button>
                    </div><!-- end commonControls -->
                </div><!-- end mainSection -->

                <!-- Diff比較セクション -->
                <div id="diffSection" class="tab-section" style="display: none;">
                    <div class="diff-container">
                        <h2>🔍 改ざん検出 (Diff比較)</h2>
                        <p class="diff-description">透かし入りの原本と、加工後の画像を比較して差分を可視化します。</p>

                        <div class="diff-inputs">
                            <div class="diff-input-group">
                                <label>📥 Before (透かし入り原本)</label>
                                <input type="file" id="beforeImage" accept="image/*">
                                <div id="beforePreview" class="diff-preview"></div>
                            </div>
                            <div class="diff-input-group">
                                <label>📥 After (加工後の画像)</label>
                                <input type="file" id="afterImage" accept="image/*">
                                <div id="afterPreview" class="diff-preview"></div>
                            </div>
                        </div>

                        <div class="diff-controls">
                            <div class="control-group">
                                <label for="gainSlider">🔆 増幅 (Gain): <span id="gainValue">4</span>x</label>
                                <input type="range" id="gainSlider" min="1" max="10" value="4">
                            </div>
                            <div class="control-group">
                                <label for="thresholdSlider">🎚️ 閾値 (Threshold): <span
                                        id="thresholdValue">10</span></label>
                                <input type="range" id="thresholdSlider" min="0" max="50" value="10">
                            </div>
                        </div>

                        <button class="generate-diff-btn" id="generateDiffBtn">🔍 差分を生成</button>

                        <div id="diffResult" class="diff-result" style="display: none;">
                            <h3>差分結果</h3>
                            <p class="diff-hint">明るい部分ほど変更が大きい箇所です</p>
                            <canvas id="diffCanvas"></canvas>
                            <button class="download-btn" id="downloadDiffBtn">💾 差分画像を保存</button>
                        </div>
                    </div>
                </div><!-- end diffSection -->
        </main>

        <footer class="footer">
            <p>画像はサーバーにアップロードされません。すべてブラウザ内で処理されます。</p>
        </footer>
    </div>

    <script src="app.js"></script>
</body>

</html>